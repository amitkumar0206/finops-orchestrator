AWSTemplateFormatVersion: '2010-09-09'
Description: 'FinOps AI Cost Intelligence Platform - Infrastructure Stack (Glue DB managed externally)'

Parameters:
  Environment:
    Type: String
    Default: production
    AllowedValues: [development, staging, production]
    Description: Environment name

  VpcCIDR:
    Type: String
    Default: '10.0.0.0/16'
    Description: CIDR block for the VPC

  DatabasePassword:
    Type: String
    NoEcho: true
    MinLength: 8
    MaxLength: 128
    Description: Password for the PostgreSQL database

  BedrockModelId:
    Type: String
    Default: us.amazon.nova-premier-v1:0
    Description: The AWS Bedrock model ID to use for LLM operations
    AllowedValues:
      - us.amazon.nova-premier-v1:0
      - us.amazon.nova-pro-v1:0
      - us.amazon.nova-lite-v1:0
      - us.amazon.nova-micro-v1:0
      - amazon.nova-premier-v1:0
      - amazon.nova-2-lite-v1:0
      - amazon.nova-2-sonic-v1:0
      - amazon.nova-pro-v1:0
      - amazon.nova-lite-v1:0
      - amazon.nova-micro-v1:0
      - meta.llama3-70b-instruct-v1:0
      - meta.llama3-8b-instruct-v1:0
      - mistral.mistral-large-2402-v1:0
      - mistral.mixtral-8x7b-instruct-v0:1
      - cohere.command-r-plus-v1:0
      - amazon.titan-text-express-v1

  S3BucketName:
    Type: String
    Description: S3 bucket name for cost data and reports

  CurReportBucketName:
    Type: String
    Default: ''
    Description: >
      (Optional) Existing S3 bucket that receives AWS Cost and Usage Reports (leave blank to skip Glue crawler creation)

  CurReportPrefix:
    Type: String
    Default: cost-reports/
    Description: S3 prefix within the CUR bucket containing Parquet reports (must end with '/')

  CurDatabaseName:
    Type: String
    Default: cost_usage_db
    Description: Glue Data Catalog database name for CUR tables (created externally via setup script)

  # Route 53 / Custom Domain Parameters
  DomainName:
    Type: String
    Default: ''
    Description: >
      (Optional) Custom domain name for the application (e.g., finops.yourdomain.com).
      Leave blank to use ALB DNS name only.

  HostedZoneId:
    Type: String
    Default: ''
    Description: >
      (Optional) Route 53 Hosted Zone ID for the domain.
      Required if DomainName is provided. Find this in Route 53 console.

  CreateACMCertificate:
    Type: String
    AllowedValues: ['true', 'false']
    Default: 'false'
    Description: >
      Set to 'true' to create an ACM certificate for HTTPS.
      Requires DomainName and HostedZoneId to be set.

Conditions:
  IsProduction: !Equals [!Ref Environment, production]
  HasCustomDomain: !And
    - !Not [!Equals [!Ref DomainName, '']]
    - !Not [!Equals [!Ref HostedZoneId, '']]
  CreateCertificate: !And
    - !Not [!Equals [!Ref DomainName, '']]
    - !Not [!Equals [!Ref HostedZoneId, '']]
    - !Equals [!Ref CreateACMCertificate, 'true']

Resources:
  # VPC and Networking
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCIDR
      EnableDnsHostnames: true
      EnableDnsSupport: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-vpc'

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Sub 
        - '${Octet0}.${Octet1}.1.0/24'
        - Octet0: !Select [0, !Split ['.', !Ref VpcCIDR]]
          Octet1: !Select [1, !Split ['.', !Ref VpcCIDR]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet-1'

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Sub 
        - '${Octet0}.${Octet1}.2.0/24'
        - Octet0: !Select [0, !Split ['.', !Ref VpcCIDR]]
          Octet1: !Select [1, !Split ['.', !Ref VpcCIDR]]
      MapPublicIpOnLaunch: true
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-subnet-2'

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [0, !GetAZs '']
      CidrBlock: !Sub 
        - '${Octet0}.${Octet1}.10.0/24'
        - Octet0: !Select [0, !Split ['.', !Ref VpcCIDR]]
          Octet1: !Select [1, !Split ['.', !Ref VpcCIDR]]
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-1'

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select [1, !GetAZs '']
      CidrBlock: !Sub 
        - '${Octet0}.${Octet1}.11.0/24'
        - Octet0: !Select [0, !Split ['.', !Ref VpcCIDR]]
          Octet1: !Select [1, !Split ['.', !Ref VpcCIDR]]
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-subnet-2'

  # Internet Gateway
  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Properties:
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-igw'

  InternetGatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      InternetGatewayId: !Ref InternetGateway
      VpcId: !Ref VPC

  # NAT Gateway
  NatGateway1EIP:
    Type: AWS::EC2::EIP
    DependsOn: InternetGatewayAttachment
    Properties:
      Domain: vpc

  NatGateway1:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatGateway1EIP.AllocationId
      SubnetId: !Ref PublicSubnet1

  # Route Tables
  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-public-routes'

  DefaultPublicRoute:
    Type: AWS::EC2::Route
    DependsOn: InternetGatewayAttachment
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet1

  PublicSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PublicRouteTable
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTable1:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-private-routes-1'

  DefaultPrivateRoute1:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGateway1

  PrivateSubnet1RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet1

  PrivateSubnet2RouteTableAssociation:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      RouteTableId: !Ref PrivateRouteTable1
      SubnetId: !Ref PrivateSubnet2

  # Security Groups
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-alb-sg'
      GroupDescription: Security group for Application Load Balancer
      VpcId: !Ref VPC
      SecurityGroupIngress:
        # Port 80 - Whitelisted IPs only
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 172.111.223.2/32
          Description: Whitelisted IP 1
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 154.47.24.233/32
          Description: Whitelisted IP 2
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 188.166.203.205/32
          Description: Whitelisted IP 3
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 149.22.92.65/32
          Description: Whitelisted IP 4
        # Port 443 - Whitelisted IPs only
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 172.111.223.2/32
          Description: Whitelisted IP 1
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 154.47.24.233/32
          Description: Whitelisted IP 2
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 188.166.203.205/32
          Description: Whitelisted IP 3
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 149.22.92.65/32
          Description: Whitelisted IP 4
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  ECSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-ecs-sg'
      GroupDescription: Security group for ECS tasks
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 8000
          ToPort: 8000
          SourceSecurityGroupId: !Ref ALBSecurityGroup
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          SourceSecurityGroupId: !Ref ALBSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  DatabaseSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-db-sg'
      GroupDescription: Security group for RDS database
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ECSSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  # RDS PostgreSQL Database
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for RDS database
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-db-subnet-group'

  Database:
    Type: AWS::RDS::DBInstance
    DeletionPolicy: Snapshot
    Properties:
      DBInstanceIdentifier: !Sub '${AWS::StackName}-postgres'
      DBName: finops
      DBInstanceClass: db.t3.medium
      Engine: postgres
      EngineVersion: '15.14'
      MasterUsername: finops
      MasterUserPassword: !Ref DatabasePassword
      AllocatedStorage: 100
      StorageType: gp3
      StorageEncrypted: true
      VPCSecurityGroups:
        - !Ref DatabaseSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7
      MultiAZ: !If [IsProduction, true, false]
      PubliclyAccessible: false
      DeletionProtection: !If [IsProduction, true, false]
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-postgres'
        - Key: Schedule
          Value: running

  # ElastiCache Valkey
  CacheSubnetGroup:
    Type: AWS::ElastiCache::SubnetGroup
    Properties:
      Description: Subnet group for Valkey cache
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet2

  ValkeySecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupName: !Sub '${AWS::StackName}-valkey-sg'
      GroupDescription: Security group for Valkey cache allowing ECS tasks access
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 6379
          ToPort: 6379
          SourceSecurityGroupId: !Ref ECSSecurityGroup
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  ValkeyCache:
    Type: AWS::ElastiCache::ReplicationGroup
    Properties:
      ReplicationGroupId: !Sub '${AWS::StackName}-valkey'
      ReplicationGroupDescription: !Sub 'Valkey cache cluster for ${AWS::StackName}'
      Engine: valkey
      EngineVersion: '7.2'
      CacheNodeType: cache.t3.micro
      NumCacheClusters: 2
      Port: 6379
      SecurityGroupIds:
        - !Ref ValkeySecurityGroup
      CacheSubnetGroupName: !Ref CacheSubnetGroup
      AtRestEncryptionEnabled: true
      TransitEncryptionEnabled: false
      AutoMinorVersionUpgrade: true
      MultiAZEnabled: true

  # S3 Bucket - Managed outside CloudFormation for idempotency
  # The deploy.sh script creates this bucket before running CloudFormation
  # This prevents "AlreadyExists" errors during redeployment
  # S3Bucket:
  #   Type: AWS::S3::Bucket
  #   DeletionPolicy: Retain
  #   UpdateReplacePolicy: Retain
  #   Properties:
  #     BucketName: !Ref S3BucketName
  #     BucketEncryption:
  #       ServerSideEncryptionConfiguration:
  #         - ServerSideEncryptionByDefault:
  #             SSEAlgorithm: AES256
  #     VersioningConfiguration:
  #       Status: Enabled
  #     LifecycleConfiguration:
  #       Rules:
  #         - Id: DeleteIncompleteMultipartUploads
  #           Status: Enabled
  #           AbortIncompleteMultipartUpload:
  #             DaysAfterInitiation: 1
  #     PublicAccessBlockConfiguration:
  #       BlockPublicAcls: true
  #       BlockPublicPolicy: true
  #       IgnorePublicAcls: true
  #       RestrictPublicBuckets: true

  # ECS Cluster
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub '${AWS::StackName}-cluster'
      CapacityProviders:
        - FARGATE
        - FARGATE_SPOT
      DefaultCapacityProviderStrategy:
        - CapacityProvider: FARGATE
          Weight: 1

  # Application Load Balancer
  ApplicationLoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub '${AWS::StackName}-alb'
      Scheme: internet-facing
      SecurityGroups:
        - !Ref ALBSecurityGroup
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      Type: application
      

  # Glue Database for CUR (created manually or via deploy script)
  # Note: Glue Crawler removed - using Athena Partition Projection instead
  # See: infrastructure/sql/create_cur_table_with_projection.sql
  
  # Note: CurGlueDatabase resource removed - database is created externally via setup script
  # This prevents CloudFormation errors when database already exists
  # Database is created by: scripts/setup/setup-athena-cur.sh
  
  # (Removed WAF WebACL association, now using Security Group for IP whitelisting)

  # IAM Roles
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: '*'

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: FinOpsAppPermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # S3 Access - Both Athena results bucket AND CUR data bucket
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:DeleteObject
                Resource:
                  - !Sub 'arn:aws:s3:::${S3BucketName}/*'  # Athena results bucket
                  - !Sub 'arn:aws:s3:::${CurReportBucketName}/*'  # CUR data bucket
              - Effect: Allow
                Action:
                  - s3:ListBucket
                  - s3:GetBucketLocation
                Resource:
                  - !Sub 'arn:aws:s3:::${S3BucketName}'  # Athena results bucket
                  - !Sub 'arn:aws:s3:::${CurReportBucketName}'  # CUR data bucket
              # Glue Catalog Access for Athena queries
              - Effect: Allow
                Action:
                  - glue:GetDatabase
                  - glue:GetTable
                  - glue:GetPartitions
                  - glue:GetPartition
                Resource: '*'
              # Athena Query Execution
              - Effect: Allow
                Action:
                  - athena:StartQueryExecution
                  - athena:GetQueryExecution
                  - athena:GetQueryResults
                  - athena:StopQueryExecution
                  - athena:GetWorkGroup
                Resource: '*'
              # Cost Explorer API
              - Effect: Allow
                Action:
                  - ce:GetCostAndUsage
                  - ce:GetUsageReport
                  - ce:GetRightsizingRecommendation
                  - ce:GetDimensionValues
                  - cur:DescribeReportDefinitions
                Resource: '*'
              # Bedrock LLM Access
              - Effect: Allow
                Action:
                  - bedrock:InvokeModel
                  - bedrock:InvokeModelWithResponseStream
                  - bedrock:ListFoundationModels
                  - bedrock:GetFoundationModel
                Resource: 
                  - 'arn:aws:bedrock:*::foundation-model/*'
                  - !Sub 'arn:aws:bedrock:*:${AWS::AccountId}:inference-profile/*'
                  # Allow cross-region inference profiles (Nova Premier routes to us-west-2)
                  # Covers all Bedrock models including:
                  # - Amazon Nova family (Premier, Pro, Lite, Micro) via inference profiles
                  # - Meta Llama 3 models (70B, 8B)
                  # - Mistral models (Large, Mixtral)
                  # - Cohere Command models
                  # - Amazon Titan Text models
        - PolicyName: EcsExecSessionManagerPermissions
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              # Required for ECS Exec (Session Manager channels)
              - Effect: Allow
                Action:
                  - ssmmessages:CreateControlChannel
                  - ssmmessages:CreateDataChannel
                  - ssmmessages:OpenControlChannel
                  - ssmmessages:OpenDataChannel
                Resource: '*'

  # ACM Certificate for HTTPS (optional)
  SSLCertificate:
    Type: AWS::CertificateManager::Certificate
    Condition: CreateCertificate
    Properties:
      DomainName: !Ref DomainName
      ValidationMethod: DNS
      DomainValidationOptions:
        - DomainName: !Ref DomainName
          HostedZoneId: !Ref HostedZoneId
      Tags:
        - Key: Name
          Value: !Sub '${AWS::StackName}-certificate'

  # Route 53 Record for custom domain
  DNSRecord:
    Type: AWS::Route53::RecordSet
    Condition: HasCustomDomain
    DependsOn: ApplicationLoadBalancer
    Properties:
      HostedZoneId: !Ref HostedZoneId
      Name: !Ref DomainName
      Type: A
      AliasTarget:
        DNSName: !GetAtt ApplicationLoadBalancer.DNSName
        HostedZoneId: !GetAtt ApplicationLoadBalancer.CanonicalHostedZoneID
        EvaluateTargetHealth: true
      Comment: !Sub 'DNS record for ${AWS::StackName} FinOps platform'

Outputs:
  TemplateVersion:
    Description: Template version marker to force stack template update (Nova AllowedValues fix)
    Value: '2025-12-03-nova-allowlist-fix'
  VPCId:
    Description: VPC ID
    Value: !Ref VPC
    Export:
      Name: !Sub '${AWS::StackName}-vpc-id'

  DatabaseEndpoint:
    Description: RDS Database Endpoint
    Value: !GetAtt Database.Endpoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-db-endpoint'

  ValkeyEndpoint:
    Description: Valkey Cache Endpoint
    Value: !GetAtt ValkeyCache.PrimaryEndPoint.Address
    Export:
      Name: !Sub '${AWS::StackName}-valkey-endpoint'

  LoadBalancerDNS:
    Description: Load Balancer DNS Name
    Value: !GetAtt ApplicationLoadBalancer.DNSName
    Export:
      Name: !Sub '${AWS::StackName}-alb-dns'

  LoadBalancerArn:
    Description: Load Balancer ARN
    Value: !Ref ApplicationLoadBalancer
    Export:
      Name: !Sub '${AWS::StackName}-alb-arn'

  ECSClusterName:
    Description: ECS Cluster Name
    Value: !Ref ECSCluster
    Export:
      Name: !Sub '${AWS::StackName}-ecs-cluster'

  ECSSecurityGroupId:
    Description: ECS Security Group ID
    Value: !Ref ECSSecurityGroup
    Export:
      Name: !Sub '${AWS::StackName}-ecs-sg'

  ApplicationURL:
    Description: Application URL (Custom Domain or ALB DNS)
    Value: !If
      - HasCustomDomain
      - !Sub 'http://${DomainName}'
      - !Sub 'http://${ApplicationLoadBalancer.DNSName}'
    Export:
      Name: !Sub '${AWS::StackName}-app-url'

  CustomDomain:
    Condition: HasCustomDomain
    Description: Custom Domain Name
    Value: !Ref DomainName
    Export:
      Name: !Sub '${AWS::StackName}-domain'

  CertificateArn:
    Condition: CreateCertificate
    Description: ACM Certificate ARN for HTTPS
    Value: !Ref SSLCertificate
    Export:
      Name: !Sub '${AWS::StackName}-certificate-arn'

  ECSTaskExecutionRoleArn:
    Description: ECS Task Execution Role ARN
    Value: !GetAtt ECSTaskExecutionRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ecs-execution-role'

  ECSTaskRoleArn:
    Description: ECS Task Role ARN
    Value: !GetAtt ECSTaskRole.Arn
    Export:
      Name: !Sub '${AWS::StackName}-ecs-task-role'

  PrivateSubnet1Id:
    Description: Private Subnet 1 ID
    Value: !Ref PrivateSubnet1
    Export:
      Name: !Sub '${AWS::StackName}-private-subnet-1'

  PrivateSubnet2Id:
    Description: Private Subnet 2 ID
    Value: !Ref PrivateSubnet2
    Export:
      Name: !Sub '${AWS::StackName}-private-subnet-2'

  S3BucketName:
    Description: S3 Bucket Name
    Value: !Ref S3BucketName
    Export:
      Name: !Sub '${AWS::StackName}-s3-bucket'
